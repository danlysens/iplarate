<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–û—Å—Ç—Ä–æ–≤ —Å–æ–∫—Ä–æ–≤–∏—â –∏ –ª–æ–≤—É—à–∫–∏ ‚Äî –ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä</title>
  <style>
    * { box-sizing: border-box; user-select: none; }
    body {
      margin: 0; padding: 0;
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(135deg, #4facfe, #00f2fe);
      color: #2c3e50;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .screen { display: none; width: 100%; max-width: 600px; }
    .active { display: block !important; }
    h1 {
      font-size: 2.2rem; color: white;
      text-shadow: 0 2px 5px rgba(0,0,0,0.3);
      margin-bottom: 20px;
    }
    .btn {
      padding: 12px 24px;
      font-size: 1.1rem;
      margin: 10px;
      border: none;
      border-radius: 50px;
      background: white;
      color: #2c3e50;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      transition: all 0.2s;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 14px rgba(0,0,0,0.25); }
    .btn:active { transform: translateY(0); }
    .input-group {
      margin: 20px 0;
    }
    input {
      padding: 12px;
      font-size: 1.1rem;
      width: 200px;
      border: none;
      border-radius: 50px;
      text-align: center;
      margin: 0 10px;
    }
    #lobby-info {
      background: rgba(255,255,255,0.85);
      padding: 15px;
      border-radius: 20px;
      margin: 20px 0;
      font-weight: 600;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }
    #game-info {
      font-size: 1.2rem;
      font-weight: 700;
      padding: 12px 24px;
      border-radius: 40px;
      margin: 15px 0;
      box-shadow: 0 4px 12px rgba(0,0,0,0.18);
    }
    .player-1-turn { background: rgba(255,255,255,0.92); color: #e74c3c; }
    .player-2-turn { background: rgba(255,255,255,0.92); color: #3498db; }
    #board {
      display: inline-grid;
      grid-template-columns: repeat(10, 42px);
      gap: 2px;
      margin: 20px auto;
      background: rgba(255,255,255,0.15);
      padding: 10px;
      border-radius: 12px;
      backdrop-filter: blur(6px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.2);
    }
    .cell {
      width: 42px; height: 42px;
      background: rgba(255,255,255,0.7);
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-weight: bold; font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .cell:hover { transform: scale(1.05); background: rgba(255,255,255,0.9); }
    .start { background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; }
    .treasure { background: linear-gradient(135deg, #f1c40f, #f39c12); color: #2c3e50; }
    .player { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }
    .trap-revealed {
      animation: flashTrap 0.6s ease;
      color: white !important;
    }
    @keyframes flashTrap {
      0%,100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231,76,60,0.7); }
      50% { transform: scale(1.1); box-shadow: 0 0 0 14px rgba(231,76,60,0); }
    }
    .win { animation: celebrate 0.8s ease infinite; }
    @keyframes celebrate {
      0%,100% { transform: rotate(0deg); }
      25%,75% { transform: rotate(4deg); }
      50% { transform: rotate(-4deg); }
    }
    .status { margin-top: 10px; font-style: italic; color: white; }
  </style>
</head>
<body>
  <!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
  <div id="menu-screen" class="screen active">
    <h1>üèùÔ∏è –û—Å—Ç—Ä–æ–≤ —Å–æ–∫—Ä–æ–≤–∏—â</h1>
    <button id="btn-create" class="btn">–°–æ–∑–¥–∞—Ç—å –ª–æ–±–±–∏</button>
    <div class="input-group">
      <input type="text" id="room-code" placeholder="–ö–æ–¥ –ª–æ–±–±–∏" maxlength="6" />
      <button id="btn-join" class="btn">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
    </div>
    <div class="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ SocketsBay (–ø—É–±–ª–∏—á–Ω—ã–π —Å–µ—Ä–≤–µ—Ä)</div>
  </div>

  <!-- –õ–æ–±–±–∏ -->
  <div id="lobby-screen" class="screen">
    <h1>üèòÔ∏è –õ–æ–±–±–∏</h1>
    <div id="lobby-info">–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤...</div>
    <button id="btn-start" class="btn" disabled>–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
    <button id="btn-lobby-back" class="btn">–ù–∞–∑–∞–¥</button>
  </div>

  <!-- –ò–≥—Ä–∞ -->
  <div id="game-screen" class="screen">
    <h1>üó∫Ô∏è –ò–≥—Ä–∞</h1>
    <div id="game-info">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
    <div id="board"></div>
    <button id="btn-game-back" class="btn">–í—ã–π—Ç–∏</button>
  </div>

  <script>
    // === –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ===
    let ws = null;
    let roomId = null;
    let playerId = null; // 'host' –∏–ª–∏ 'guest'
    let isHost = false;

    const screens = {
      menu: document.getElementById('menu-screen'),
      lobby: document.getElementById('lobby-screen'),
      game: document.getElementById('game-screen')
    };

    function showScreen(name) {
      Object.values(screens).forEach(s => s.classList.remove('active'));
      screens[name].classList.add('active');
    }

    // === –ì–ï–ù–ï–†–ê–¶–ò–Ø –ö–û–î–ê –õ–û–ë–ë–ò ===
    function generateRoomId() {
      return Math.random().toString(36).substring(2, 8).toUpperCase();
    }

    // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò–ì–†–´ ===
    const size = 10;
    let currentPlayerTurn = 1; // 1 –∏–ª–∏ 2
    let phase = 'placeTraps';
    let traps = new Map();
    let playerPos = { 1: [9, 0], 2: [9, 0] };
    let trapsPlaced = { 1: 0, 2: 0 };
    const maxTraps = 3;

    const boardEl = document.getElementById('board');
    const gameInfo = document.getElementById('game-info');

    function initBoard() {
      boardEl.innerHTML = '';
      for (let r = 0; r < size; r++) {
        for (let c = 0; c < size; c++) {
          const cell = document.createElement('div');
          cell.className = 'cell';
          cell.dataset.row = r;
          cell.dataset.col = c;
          if (r === 9 && c === 0) cell.classList.add('start');
          if (r === 0 && c === 9) cell.classList.add('treasure');
          boardEl.appendChild(cell);
        }
      }
    }

    function updateGameInfo() {
      gameInfo.className = '';
      if (phase === 'ended') {
        gameInfo.textContent = '–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞!';
        gameInfo.style.background = 'rgba(255,255,255,0.9)';
        gameInfo.style.color = '#27ae60';
        return;
      }

      const isMyTurn = (playerId === 'host' && currentPlayerTurn === 1) ||
                       (playerId === 'guest' && currentPlayerTurn === 2);

      gameInfo.textContent = isMyTurn ? `–í–∞—à —Ö–æ–¥!` : `–•–æ–¥ —Å–æ–ø–µ—Ä–Ω–∏–∫–∞...`;
      gameInfo.classList.add(currentPlayerTurn === 1 ? 'player-1-turn' : 'player-2-turn');
    }

    function render() {
      document.querySelectorAll('.cell').forEach(cell => {
        cell.classList.remove('player', 'trap-revealed');
        cell.textContent = '';
      });

      if (document.querySelector('.start')) document.querySelector('.start').textContent = 'üè†';
      if (document.querySelector('.treasure')) document.querySelector('.treasure').textContent = 'üèÜ';

      // –ü–æ–∫–∞–∑ –ª–æ–≤—É—à–µ–∫ —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏—Ö –∏ —Ç–æ–ª—å–∫–æ –≤ placeTraps
      if (phase === 'placeTraps') {
        const myId = playerId === 'host' ? 1 : 2;
        traps.forEach((owner, key) => {
          if (owner === myId) {
            const [r, c] = key.split(',').map(Number);
            const el = document.querySelector(`.cell[data-row="${r}"][data-col="${c}"]`);
            if (el) el.textContent = '‚ö†Ô∏è';
          }
        });
      }

      // –ò–≥—Ä–æ–∫–∏
      for (const [id, [r, c]] of Object.entries(playerPos)) {
        const el = document.querySelector(`.cell[data-row="${r}"][data-col="${c}"]`);
        if (el) {
          el.classList.add('player');
          el.textContent = `P${id}`;
        }
      }

      updateGameInfo();
    }

    function sendGameAction(action, data) {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'game', action, data }));
      }
    }

    function handleGameAction(action, data) {
      switch (action) {
        case 'sync':
          // –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
          currentPlayerTurn = data.currentPlayerTurn;
          phase = data.phase;
          traps = new Map(Object.entries(data.traps || {}));
          playerPos = data.playerPos;
          trapsPlaced = data.trapsPlaced;
          render();
          break;

        case 'placeTrap':
          const { row, col, playerId: pId } = data;
          const owner = pId === 'host' ? 1 : 2;
          traps.set(`${row},${col}`, owner);
          trapsPlaced = { ...trapsPlaced, [owner]: (trapsPlaced[owner] || 0) + 1 };
          if (trapsPlaced[1] >= maxTraps && trapsPlaced[2] >= maxTraps) {
            phase = 'playGame';
            currentPlayerTurn = 1;
          }
          render();
          break;

        case 'move':
          const { dr, dc, movingPlayerId } = data;
          const mPlayer = movingPlayerId === 'host' ? 1 : 2;
          const [r, c] = playerPos[mPlayer];
          playerPos[mPlayer] = [r + dr, c + dc];

          const key = `${r + dr},${c + dc}`;
          if (traps.has(key)) {
            const owner = traps.get(key);
            if (owner !== mPlayer) {
              // –ü–æ–ø–∞–ª –≤ –ª–æ–≤—É—à–∫—É —Å–æ–ø–µ—Ä–Ω–∏–∫–∞ ‚Äî –≤–æ–∑–≤—Ä–∞—Ç
              setTimeout(() => {
                playerPos[mPlayer] = [9, 0];
                currentPlayerTurn = currentPlayerTurn === 1 ? 2 : 1;
                sendGameAction('sync', {
                  currentPlayerTurn,
                  phase,
                  traps: Object.fromEntries(traps),
                  playerPos,
                  trapsPlaced
                });
                render();
              }, 600);
            }
          }

          // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–±–µ–¥—ã
          if (playerPos[mPlayer][0] === 0 && playerPos[mPlayer][1] === 9) {
            phase = 'ended';
          } else if (!traps.has(key) || (traps.has(key) && traps.get(key) === mPlayer)) {
            // –ü–µ—Ä–µ–¥–∞—á–∞ —Ö–æ–¥–∞
            currentPlayerTurn = currentPlayerTurn === 1 ? 2 : 1;
          }

          sendGameAction('sync', {
            currentPlayerTurn,
            phase,
            traps: Object.fromEntries(traps),
            playerPos,
            trapsPlaced
          });
          render();
          break;
      }
    }

    // === –°–û–ë–´–¢–ò–Ø –ò–ì–†–´ ===
    boardEl.addEventListener('click', (e) => {
      if (!e.target.classList.contains('cell') || phase === 'ended') return;

      const r = parseInt(e.target.dataset.row);
      const c = parseInt(e.target.dataset.col);

      if (phase === 'placeTraps') {
        const isMyTurn = (playerId === 'host' && currentPlayerTurn === 1) ||
                         (playerId === 'guest' && currentPlayerTurn === 2);
        if (!isMyTurn) return;

        if ((r === 9 && c === 0) || (r === 0 && c === 9)) return;
        const key = `${r},${c}`;
        if (traps.has(key)) return;

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
        sendGameAction('placeTrap', { row: r, col: c, playerId });
        // –õ–æ–∫–∞–ª—å–Ω–æ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º ‚Äî –∂–¥—ë–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
      } else if (phase === 'playGame') {
        const isMyTurn = (playerId === 'host' && currentPlayerTurn === 1) ||
                         (playerId === 'guest' && currentPlayerTurn === 2);
        if (!isMyTurn) return;

        const myPlayerId = playerId === 'host' ? 1 : 2;
        const [pr, pc] = playerPos[myPlayerId];
        const dr = r - pr;
        const dc = c - pc;
        if (Math.abs(dr) + Math.abs(dc) !== 1) return;

        sendGameAction('move', { dr, dc, movingPlayerId: playerId });
      }
    });

    // === –û–ë–†–ê–ë–û–¢–ö–ê –ö–ù–û–ü–û–ö ===
    document.getElementById('btn-create').onclick = () => {
      roomId = generateRoomId();
      connectToRoom(roomId, true);
    };

    document.getElementById('btn-join').onclick = () => {
      const code = document.getElementById('room-code').value.trim().toUpperCase();
      if (code) {
        connectToRoom(code, false);
      }
    };

    document.getElementById('btn-lobby-back').onclick = () => {
      if (ws) ws.close();
      showScreen('menu');
    };

    document.getElementById('btn-game-back').onclick = () => {
      if (ws) ws.close();
      showScreen('menu');
    };

    // === –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –õ–û–ë–ë–ò ===
    function connectToRoom(id, asHost) {
      roomId = id;
      isHost = asHost;
      playerId = asHost ? 'host' : 'guest';

      const url = `wss://socketsbay.com/wss/v2/2/${roomId}/`;
      ws = new WebSocket(url);

      ws.onopen = () => {
        ws.send(JSON.stringify({ type: 'join', playerId, isHost }));
        showScreen('lobby');
        updateLobbyUI('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
      };

      ws.onmessage = (event) => {
        try {
          const msg = JSON.parse(event.data);
          if (msg.type === 'lobby') {
            updateLobbyUI(msg.status, msg.players);
            document.getElementById('btn-start').disabled = !msg.canStart;
          } else if (msg.type === 'game_start') {
            // –ù–∞—á–∏–Ω–∞–µ–º –∏–≥—Ä—É
            currentPlayerTurn = 1;
            phase = 'placeTraps';
            traps = new Map();
            playerPos = { 1: [9, 0], 2: [9, 0] };
            trapsPlaced = { 1: 0, 2: 0 };
            initBoard();
            showScreen('game');
            render();
          } else if (msg.type === 'game') {
            handleGameAction(msg.action, msg.data);
          }
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:', e);
        }
      };

      ws.onclose = () => {
        alert('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ª–æ–±–±–∏ –ø–æ—Ç–µ—Ä—è–Ω–æ.');
        showScreen('menu');
      };

      ws.onerror = (err) => {
        console.error('WebSocket –æ—à–∏–±–∫–∞:', err);
      };
    }

    function updateLobbyUI(status, players = []) {
      const lobbyInfo = document.getElementById('lobby-info');
      lobbyInfo.innerHTML = `
        <div>–ö–æ–¥ –ª–æ–±–±–∏: <strong>${roomId}</strong></div>
        <div>–ò–≥—Ä–æ–∫–∏: ${players.length}/2</div>
        <div>${players.map(p => p === 'host' ? '–ò–≥—Ä–æ–∫ 1 (—Ö–æ–∑—è–∏–Ω)' : '–ò–≥—Ä–æ–∫ 2').join(', ') || '‚Äî'}</div>
        <div style="margin-top:10px;">${status}</div>
      `;
    }

    document.getElementById('btn-start').onclick = () => {
      if (isHost && ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'start_game' }));
      }
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    initBoard();
  </script>
</body>
</html>
